<!DOCTYPE html>
<!--
The MIT License

Copyright 2014 Long.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
-->
<html>
    <head>
        <title>Acoustic Search</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <script
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5NvcrQ54Rbzdxpo3FtJsAyvUjy6O3cn4&sensor=false">
        </script>
        <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="js/illiad.min.js"></script>
        <script src="js/jquery-ajax-blob-arraybuffer.js"></script>
        <script src="js/oms.min.js"></script>
        <script src="js/math.min.js"></script>
        <script src="js/utilities.js"></script>

        <script>
            //window.open("https://acoustic.ifp.illinois.edu:8081");
            var gLoc;
            var map;
            var oms;
            var iw = new google.maps.InfoWindow();
            var audioCtx = new AudioContext();
            
            /**
             * acousticSearch
             * 
             * @returns {none}
             */
            function acousticSearch() {
                var markers = oms.getMarkers();
                for (var i = 0; i <markers.length;i++){
                    markers[i].setMap(null);
                }
                oms.clearMarkers();
                
                var q = getBasicQuery();
                
                // Handle tag and pred separately
                if ($('input[name="infer"]:checked').val() === "tag"){
                    if ($("#kw").val()){
                        q.kw = $("#kw").val();
                    }
                }
                else if ($('input[name="infer"]:checked').val() === "pred"){
                    var model = getPredModel();
                }
                
                // Query events
                IllQueryCol('publicDb', 'publicUser', 'publicPwd', 'event', q, function(events){
                    for (var j = 0; j <events.length;j++){
                        // Use model to augment score
                        if (model){
                            var feat = [];
                            for (var i=0; i < model.mu.length; i++){
                                feat.push(0);
                            }
                            var rIdx = Object.keys(events[j].TFRidge); // ridge indexes
                            for (var i=0;i < rIdx.length; i++){
                                var f = events[j].TFRidge[rIdx[i]].freq;
                                feat[i] = math.mean(f);
                                feat[i+5] = math.std(f);
                            }
                            for (var i=0;i< rIdx.length; i++){
                                var t = events[j].TFRidge[rIdx[i]].time;
                                //var d = math.subtract(t,math.min(t)); // duration
                                feat[model.mu.length/2+i] = math.mean(t);
                                feat[model.mu.length/2+i+5] = math.std(t);
                            }
                            events[j].score = math.sum(events[j].logProb)*model.predict(model, feat);
                        }
                        else{
                            events[j].score = math.sum(events[j].logProb);
                        }
                    }
                    // sort events based on score
                    events.sort(function(a, b) {
                            return -a.score + b.score;
                    });
                    for (var i = 0; i <events.length;i++){
                        // Create a marker for each event
                        var marker = new google.maps.Marker({
                            position:new google.maps.LatLng(parseFloat(events[i].location.coordinates[1]), parseFloat(events[i].location.coordinates[0])),
                            tag: events[i].tag,
                            recordDate: events[i].recordDate.$date,
                            filename: events[i].filename,
                            icon:'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld='+ (i) +'|FF776B|000000'
                        });
                        marker.setMap(map);

                        google.maps.event.addListener(marker, 'mouseover', (function(marker) {
                            return function(){
                                iw.setContent("<p>" +marker.recordDate+"<br />"+marker.tag+"</p>");
                                iw.open(map, marker);
                            };
                        })(marker));
                        google.maps.event.addListener(marker, 'mouseout', function(){
                            iw.close();
                        });
                        oms.addMarker(marker);
                    }
                }, function(){
                    alert("No event found!");
                });
            }
            
            $(function(){
                gLoc = [$('#lat').val(), $('#lng').val()];
                
                var mapProp = {
                    center:new google.maps.LatLng(gLoc[0], gLoc[1]),
                    zoom:5,
                    mapTypeId:google.maps.MapTypeId.ROADMAP
                };
                map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
                oms=new OverlappingMarkerSpiderfier(map);
                
                oms.addListener('click', function(marker) {
                    // Download sound data and play
                    IllDownGrid('publicDb', 'publicUser', 'publicPwd', 'data', marker.filename, function(data){
                        audioCtx.decodeAudioData(data, function(buf){
                            // Play the sound
                            var source = audioCtx.createBufferSource();
                            source.buffer = buf;
                            source.connect(audioCtx.destination);
                            source.start(0);
                            
                            // if pred for speech, then invoke ASR (auto speech recog) service for init help
                            /*
                            var ASR_result = '';
                            if ($('input[name="infer"]:checked').val() === "pred" && $("#classes").val() === "speech"){
                                gVoiceApi('AIzaSyD5NvcrQ54Rbzdxpo3FtJsAyvUjy6O3cn4', data, function(xscript){
                                    ASR_result = ' ';
                                    for (var i = 0; i < xscript[2].result[1].alternative.length; i++){
                                        ASR_result = ASR_result+xscript[2].result[1].alternative[i].transcript;
                                    }
                                }, function(){
                                    console.log('ASR failed');
                                });
                            }
                            */
                            // Get updated tags from the user
                            var newtag = prompt("Modify tags", marker.tag);
                            if (newtag){
                                IllUpdateCol('publicDb', 'publicUser', 'publicPwd', 'event',marker.filename, "set", '{tag:"'+newtag+'"}');
                                marker.tag = newtag;
                            }
                        }, function(error){
                            console.log('audio decoding error');
                        });
                    }, function(){
                        alert("No data found!");
                    });
                });
                
                var currDate = new Date();
                var prevDate = new Date(currDate);
                prevDate.setDate(prevDate.getDate()-1);
                $("#t1").val(prevDate.toISOString());
                $("#t2").val(currDate.toISOString());
                setInterval(function(){
                    var d = new Date();
                    document.getElementById('time').innerHTML = 'Time '+d.toISOString();
                },1000);
            });
            
        </script>
        <!-- Basic CSS -->
        <style>
            #googleMap {
                width: 85%;
                height: 100%;
                position: absolute;
                background: #000;
            }
            #forms{
                position: absolute;
                right: 0%;
            }
            .label1{
                display: block;
            }
            #button1{
                font-size: large;
            }
        </style>
    </head>
    <body>
        <div id="googleMap"></div>

        <div id="forms">
            <form id="formTime">
                <fieldset>
                    <legend id="time">Time</legend>
                    <label class="label1">From</label> <input size="25" type="text" id="t1" value="2014-09-05T04:20:38.676Z"/><br>
                    <label class="label1">To</label> <input size="25" type="text" id="t2" value="2014-09-05T04:25:38.676Z"/>
                </fieldset>
            </form>

            <form id="formFreq">
                <fieldset>
                    <legend id="freq">Frequency</legend>
                    <label class="label1">Lower frequency (Hz)</label> <input size="25" type="text" id="f1" value="0"/><br>
                    <label class="label1">Upper frequency (Hz)</label> <input size="25" type="text" id="f2" value="4000"/>
                </fieldset>
            </form>
            
            <form id="formDur">
                <fieldset>
                    <legend id="dur">Duration</legend>
                    <label class="label1">Lower duration (s)</label> <input size="25" type="text" id="dur1" value="0.0"/><br>
                    <label class="label1">Upper duration (s)</label> <input size="25" type="text" id="dur2" value="10.0"/>
                </fieldset>
            </form>
            
            <form id="formLoc">
                <fieldset>
                    <legend id="loc">Location</legend>
                    <label class="label1">Latitude</label> <input size="25" type="text" id="lat" value="40.10979"/><br>
                    <label class="label1">Longitude</label> <input size="25" type="text" id="lng" value="-88.22726"/><br>
                    <label class="label1">Radius (miles)</label> <input size="25" type="text" id="rad" value="1"/>
                </fieldset>
            </form>

            <form id="formSpeech">
                <fieldset>
                    <legend id="speech">Inference</legend>
                    <form>
                    <input type="radio" name="infer" value="tag" checked>Tag<br>
                    <input size="25" type="text" id="kw" value=""/><br>
                    
                    <input type="radio" name="infer" value="pred">Predict<br>
                    <select id="classes">
                        <option value="air_conditioner">Air conditioner</option>
                        <option value="car_horn">Car horn</option>
                        <option value="children_playing">Children playing</option>
                        <option value="dog_bark">Dog bark</option>
                        <option value="drilling">Drilling</option>
                        <option value="engine_idling">Engine idling</option>
                        <option value="gun_shot">Gun shot</option>
                        <option value="jackhammer">Jackhammer</option>
                        <option value="siren">Siren</option>
                        <option value="street_music">Street music</option>
                        <option value="knock">Knock (door, table)</option>
                        <option value="door_slam">Door slam</option>
                        <option value="steps">Steps</option>
                        <option value="chair_moving">Chair moving</option>
                        <option value="speech">Speech</option>
                    </select>
                    </form>
                </fieldset>
            </form>
            
            <input type="submit" name="button" id="button1" onclick="acousticSearch()" value="Search" />
        </div>
        
        
    </body>
</html>
